/*
 * BMP280_Funtion.c
 *
 *  Created on: Dec 12, 2023
 *      Author: Royer Sanabria
 */

#include "bmp280.h"
#include "BMP280_Funtion.h"
#include "main.h"
#include <stdint.h>
#include <stdio.h>
#include <stdbool.h>
#include <stdlib.h>
#include <string.h>

#define Delay_MAX_Trasmit 100

static BMP280_HandleTypedef bmp280;
static float pressure, temperature, humidity;
static uint16_t size;
static uint8_t Data[256];

void BMP_280_Init2(I2C_HandleTypeDef hi2c1, UART_HandleTypeDef huart2){
	 bmp280_init_default_params(&bmp280.params);
		bmp280.addr = BMP280_I2C_ADDRESS_0;
		bmp280.i2c = &hi2c1;

		while (!bmp280_init(&bmp280, &bmp280.params)) {
				sprintf((char *)Data, "B\n");
				HAL_UART_Transmit(&huart2, Data, strlen (Data), Delay_MAX_Trasmit);
			}
			bool bme280p = bmp280.id == BME280_CHIP_ID;
			sprintf((char *)Data, "Sensor Encontrado %s\n", bme280p ? "BME280\r\n" : "BMP280\r\n");
				HAL_UART_Transmit(&huart2, Data, strlen (Data), Delay_MAX_Trasmit);

}

void BMP_280_Read(I2C_HandleTypeDef hi2c1, UART_HandleTypeDef huart2){

	HAL_Delay(1000);

	  	  while (!bmp280_read_float(&bmp280, &temperature, &pressure, &humidity)) {
	  	  			size = sprintf((char *)Data,"Temperature/pressure reading failed\r\n");
	  	  			HAL_UART_Transmit(&huart2, Data, size, Delay_MAX_Trasmit);
	  	  		}

		  	  		size = sprintf((char *)Data,"Pressure: %.2f Pa, Temperature: %.2f \r\n",pressure, temperature);
		  	  		HAL_UART_Transmit(&huart2, Data, size, 1000);
}
